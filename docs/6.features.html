<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.41">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Selecting features – Geospatial small area estimation in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-48ffa3e5b9d089919c6712c39e5b00f2.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-2be10d9e998f81ff6e49e26833438aa5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">
      Geospatial small area estimation in R
      </li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Geospatial small area estimation in R</a> 
    </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">1. Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2rsetup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">2. R setup</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3vectorfiles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3. Vector files (shapefiles)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4rasterfiles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">4. Rasters</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5surveydata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">5. Survey data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6features.qmd" class="sidebar-item-text sidebar-link">
 <span class="menu-text">6. Creating and selecting features</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Appendix: Additional resources</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#sec-features" id="toc-sec-features" class="nav-link active" data-scroll-target="#sec-features"><span class="header-section-number">3</span> Creating and selecting features</a>
  <ul class="collapse">
  <li><a href="#sec-newfeatures" id="toc-sec-newfeatures" class="nav-link" data-scroll-target="#sec-newfeatures"><span class="header-section-number">3.1</span> Creating new features e.g.&nbsp;admin means</a></li>
  <li><a href="#sec-transformations" id="toc-sec-transformations" class="nav-link" data-scroll-target="#sec-transformations"><span class="header-section-number">3.2</span> Thinking about transformations</a></li>
  <li><a href="#sec-lasso" id="toc-sec-lasso" class="nav-link" data-scroll-target="#sec-lasso"><span class="header-section-number">3.3</span> lasso and <code>glmnet</code></a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Selecting features</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-features" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Creating and selecting features</h1>
<p>Once we have all of the geospatial features, we now need to think about choosing which features we want to use in our model and whether we want to use our raw features to create new indicators. Choosing features is particularly important with geospatial data due to the sheer number of features we can create. We have already created a number of features, but we can also create new features, transform existing features, and use lasso to select features. We will discuss each of these in turn. In this section, we will be using the final, cleaned version of features in the <code>data/geovarseas.csv</code> file.</p>
<section id="sec-newfeatures" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="sec-newfeatures"><span class="header-section-number">3.1</span> Creating new features e.g.&nbsp;admin means</h2>
<p>We will be estimating models at the admin-4 level. However, this does not mean that all of our predictors must necessarily be at the admin-4 level. For example, we can create means or standard deviations at higher levels (e.g.&nbsp;admin 3). We can also create lagged means or standard deviations at the admin 4 level, as well as interactions between different features.</p>
<p>As a simple example, consider creating total population at the admin-3 level, in addition to the admin-4 level. Let’s first load the features into <code>R</code> and do a bit more cleaning:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># load features</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>features <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/geovarseas.csv"</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># the population column is mwpop</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">head</span>(features)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 526
   EA_CODE TA_CODE mwpop average_masked barecoverfraction urbancoverfraction
     &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;             &lt;dbl&gt;              &lt;dbl&gt;
1 10507801   10507  700.          0.585               407                769
2 10507072   10507  940.          0                   904                114
3 10507010   10507 1077.          0                  1525               3101
4 10507001   10507  610.          0                   673               1919
5 10507009   10507  558.          0                  1383                957
6 10507033   10507  594.          0                   738               1802
# ℹ 520 more variables: cropscoverfraction &lt;dbl&gt;, grasscoverfraction &lt;dbl&gt;,
#   mosscoverfraction &lt;dbl&gt;, waterpermanentcoverfraction &lt;dbl&gt;,
#   waterseasonalcoverfraction &lt;dbl&gt;, shrubcoverfraction &lt;dbl&gt;,
#   snowcoverfraction &lt;dbl&gt;, treecoverfraction &lt;dbl&gt;, ndvi1 &lt;dbl&gt;, ndvi2 &lt;dbl&gt;,
#   ndvi3 &lt;dbl&gt;, ndvi4 &lt;dbl&gt;, ndvi5 &lt;dbl&gt;, ndvi6 &lt;dbl&gt;, ndvi7 &lt;dbl&gt;,
#   ndvi8 &lt;dbl&gt;, ndvi9 &lt;dbl&gt;, ndvi10 &lt;dbl&gt;, ndvi11 &lt;dbl&gt;, ndvi12 &lt;dbl&gt;,
#   mosaik1 &lt;dbl&gt;, mosaik2 &lt;dbl&gt;, mosaik3 &lt;dbl&gt;, mosaik4 &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>Let’s now create one more variable, which is total population at the admin-3 level:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># create TOTAL pop at admin3 level:</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>features <span class="ot">&lt;-</span> features <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>  <span class="fu">group_by</span>(TA_CODE) <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="fu">mutate</span>(<span class="at">popTA =</span> <span class="fu">sum</span>(mwpop, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, we take advantage of the <code>tidyverse</code>’s <code>group_by()</code> and <code>mutate()</code> functions to aggregate total population up to the admin-3 level, but keeping the dataset itself at the admin-4 level.</p>
<p>As another example, let’s consider NDVI, which is a measure of vegetation (“greenness”). In countries like Malawi, NDVI can be highly predictive of poverty due to its correlation with the agricultural harvest. However, at the same time, the exact timing of NDVI measures can be very important for capturing this relationship, due to the seasonality inherent in rain-fed agricultural production. In practice, we often pull historical NDVI and then include things like long-term mean, long-term max, long-term min, and even long-term standard deviation, in addition to current values.</p>
<p>In our simple example, we downloaded 12 separate NDVI files<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> and we can use these to calculate things like min/mean/sd of NDVI throughout the year. In the <code>features</code> object, the NDVI columns are named <code>ndviM</code>, where <code>M</code> is an integer from 1 to 12, indicating the month of the year.</p>
<p>Let’s create some new values, such as the <em>annual</em> mean, max, min, and standard deviation:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy"><code class="sourceCode r"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1"></a><span class="co"># Let's first find the columns we want!</span></span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2"></a>ndvicols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"ndvi"</span>, <span class="fu">names</span>(features))</span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3"></a>features<span class="sc">$</span>ndvimean <span class="ot">&lt;-</span> <span class="fu">apply</span>(features[,ndvicols], <span class="dv">1</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4"></a>features<span class="sc">$</span>ndvistd <span class="ot">&lt;-</span> <span class="fu">apply</span>(features[,ndvicols], <span class="dv">1</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)      </span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5"></a>features<span class="sc">$</span>ndvimax <span class="ot">&lt;-</span> <span class="fu">apply</span>(features[,ndvicols], <span class="dv">1</span>, max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)      </span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6"></a>features<span class="sc">$</span>ndvimin <span class="ot">&lt;-</span> <span class="fu">apply</span>(features[,ndvicols], <span class="dv">1</span>, min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)   </span>
<span id="annotated-cell-3-7"><a href="#annotated-cell-3-7"></a><span class="fu">head</span>(features[,<span class="fu">c</span>(<span class="st">"ndvimean"</span>, <span class="st">"ndvistd"</span>, <span class="st">"ndvimax"</span>, <span class="st">"ndvimin"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  ndvimean ndvistd ndvimax ndvimin
     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1    9066.   2787.   13106    5681
2   23035.   8614.   36599   13413
3   24912.   8605.   37987   15263
4   31705    8246.   42600   20608
5   23144.   7180.   33499   14993
6   13229.   3927.   19218    8390</code></pre>
</div>
</div>
<p>Here, we take advantage of a new function we have not used before: <code>apply()</code>. The <code>apply()</code> function is very useful. In this case, we are going to “apply” a single function to different columns of <code>ndviextracted</code>. Let’s go through each row in the above code:</p>
<ol type="1">
<li>This row does something slightly more advanced. We want to find the location of the columns that contain the string “ndvi” in the column names. We can do this using <code>grep()</code>, which returns the <em>index</em> of the columns that contain the string “ndvi”. We can then use this index to find the columns we want.</li>
<li><code>ndvimean</code>: We are going to take the mean of the NDVI values for each <em>row</em>, which is what the <code>1</code> represents in the function call (if we wanted to apply it <em>down</em> columns, we would use a <code>2</code> instead). We use <code>apply()</code> to apply the <code>mean()</code> function to each row, excluding missing values. The next three rows do something similar, just calling a different function instead of the <code>mean</code>.</li>
<li>Here we are looking at the first few rows of <code>df</code>, but <em>only</em> for the new columns we just created.</li>
</ol>
</section>
<section id="sec-transformations" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="sec-transformations"><span class="header-section-number">3.2</span> Thinking about transformations</h2>
<p>In addition to creating new variables through aggregation to a higher level of geography or combining data over time, we can also transform both our (potential) predictor variables and our outcome variable, through, for example, log transformations. Why might we want to transform our variables? There are two primary reasons:</p>
<ol type="1">
<li>Improve the predictive ability of the model. For example, a log transformation can sometimes make the relationship between a predictor and the outcome more linear, which is particularly important for linear models (which are the workhorse of SAE).</li>
<li>Improve the properties of the residuals. In SAE, we often use a parametric bootstrap for point estimation and inference. In our case, we make two key assumptions: the residual is normally distributed and the random effects are normally distributed. Transforming the outcome variable, in particular, can sometimes make the residuals more normal, which can improve the properties of the bootstrap.</li>
</ol>
<p>Let’s start with the outcome: poverty rates at the admin-4 level. Before diving into this, it is important to clarify that the assumptions we make in our SAE model are not about the distribution of the outcome itself, but rather about the <em>residuals</em> and random effects. Nonetheless, outcomes that are more “normally” distributed do tend to have better properties in terms of estimation.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-poptrans" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-poptrans-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Poverty rates in Northern Malawi
</figcaption>
<div aria-describedby="fig-poptrans-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="6.features_files/figure-html/fig-poptrans-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<p>In the above figure, we show the density of poverty rates in Northern Malawi. The left panel shows the untransformed poverty rates, while the right panel shows the poverty rates after an arcsin (square root) transformation.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> We have found that this transformation performs particularly well when the outcome is a proportion, as it is in this case (it varies between 0 and 1). It is quite clear from the figure that the transformed outcome is more “normal” than the untransformed outcome. However, since we are really interested in the residuals, we discuss model diagnostics more below, where we also look at statistics for skewness and kurtosis of the residuals and random effects.</p>
<p>But since we are really interested in the residual, we can look at how a transformation might affect the predictive power of the model. To do this, we will use the <code>feols()</code> function from the package <code>fixest</code>.<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>Before we do this, however, we need to recode some of the key predictors: land cover classifications. Right now, the land cover classification values are not true proportions! They are counts of pixels of different land classifications within each EA. We need to turn these into proportions. We can do this by dividing by the total number of pixels in each EA. Let’s do this:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># find columns we want</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>landcols <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"coverfraction"</span>, <span class="fu">names</span>(features))</span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co"># how many total pixels?</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>features<span class="sc">$</span>totalpixels <span class="ot">&lt;-</span> <span class="fu">apply</span>(features[,landcols], <span class="dv">1</span>, sum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="co"># go through each one and replace with proportion:</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="cf">for</span> (i <span class="cf">in</span> landcols){</span>
<span id="cb5-7"><a href="#cb5-7"></a>  features[,i] <span class="ot">&lt;-</span> features[,i]<span class="sc">/</span>features<span class="sc">$</span>totalpixels</span>
<span id="cb5-8"><a href="#cb5-8"></a>}</span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co"># remove total pixels</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>features <span class="ot">&lt;-</span> features <span class="sc">|&gt;</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>  <span class="fu">select</span>(<span class="sc">-</span>totalpixels)</span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="fu">summary</span>(features[,landcols])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> barecoverfraction  urbancoverfraction cropscoverfraction grasscoverfraction
 Min.   :0.000000   Min.   :0.000000   Min.   :0.0000     Min.   :0.0000    
 1st Qu.:0.005634   1st Qu.:0.009176   1st Qu.:0.2756     1st Qu.:0.2449    
 Median :0.012542   Median :0.021913   Median :0.3707     Median :0.2660    
 Mean   :0.014802   Mean   :0.103282   Mean   :0.3428     Mean   :0.2533    
 3rd Qu.:0.021850   3rd Qu.:0.051555   3rd Qu.:0.4351     3rd Qu.:0.2904    
 Max.   :0.091131   Max.   :1.000000   Max.   :0.6276     Max.   :0.5254    
 mosscoverfraction waterpermanentcoverfraction waterseasonalcoverfraction
 Min.   :0         Min.   :0.0000000           Min.   :0.000000          
 1st Qu.:0         1st Qu.:0.0000000           1st Qu.:0.000000          
 Median :0         Median :0.0000000           Median :0.000000          
 Mean   :0         Mean   :0.0008774           Mean   :0.001152          
 3rd Qu.:0         3rd Qu.:0.0000000           3rd Qu.:0.000000          
 Max.   :0         Max.   :0.1184433           Max.   :0.161355          
 shrubcoverfraction snowcoverfraction treecoverfraction
 Min.   :0.0000     Min.   :0         Min.   :0.00000  
 1st Qu.:0.1160     1st Qu.:0         1st Qu.:0.08103  
 Median :0.1397     Median :0         Median :0.11777  
 Mean   :0.1307     Mean   :0         Mean   :0.15302  
 3rd Qu.:0.1594     3rd Qu.:0         3rd Qu.:0.19193  
 Max.   :0.2394     Max.   :0         Max.   :0.87709  </code></pre>
</div>
</div>
<p>The above output also provides some additional context for selecting the variables for our SAE models. In our SAE application below, we will be estimating a model using maximum likelihood estimation. In such cases, we can sometimes experience convergence issues, especially when some predictors have very little variation, In this example, several of the land cover classification variables have no variation – so they will not be selected at all in the lasso application we discuss below – but others show very little variation. Let’s remove all columns that have very little variation:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>features <span class="ot">&lt;-</span> features <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">"mosscoverfraction"</span>, <span class="st">"waterpermanentcoverfraction"</span>, </span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="st">"waterseasonalcoverfraction"</span>, <span class="st">"snowcoverfraction"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s consider the three regressions, with poverty on the left-hand side and two separate predictors, <code>cropscoverfraction</code> and <code>mwpop</code>, on the right-hand side. We estimate three separate (simple) regressions with different transformations. In column one, all variables – including the outcome – are not transformed. In column two, we transform the outcome only, leaving both of the predictors untransformed. In column three, we transform both the outcome and the predictors, using the arcsin transformation for crop cover and the log transformation for population. The results are in <a href="#tbl-povtrans" class="quarto-xref">Table&nbsp;1</a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># new data</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>pov <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ihs5ea.csv"</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co"># not we join pov INTO features. This means we have all admin 4 areas, with or without sample data</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>pov <span class="ot">&lt;-</span> features <span class="sc">|&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="fu">left_join</span>(pov, <span class="at">by =</span> <span class="st">"EA_CODE"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>  <span class="fu">mutate</span>(<span class="at">mwpop =</span> mwpop<span class="sc">/</span><span class="dv">1000</span>)</span>
<span id="cb8-7"><a href="#cb8-7"></a></span>
<span id="cb8-8"><a href="#cb8-8"></a>reg1 <span class="ot">&lt;-</span> <span class="fu">feols</span>(poor <span class="sc">~</span> cropscoverfraction <span class="sc">+</span> mwpop, <span class="at">data =</span> pov, <span class="at">weights =</span> <span class="sc">~</span>total_weights, <span class="at">vcov =</span> <span class="st">"HC1"</span>)</span>
<span id="cb8-9"><a href="#cb8-9"></a>reg2 <span class="ot">&lt;-</span> <span class="fu">feols</span>(<span class="fu">asin</span>(<span class="fu">sqrt</span>(poor)) <span class="sc">~</span> cropscoverfraction <span class="sc">+</span> mwpop, <span class="at">data =</span> pov, <span class="at">weights =</span> <span class="sc">~</span>total_weights, <span class="at">vcov =</span> <span class="st">"HC1"</span>)</span>
<span id="cb8-10"><a href="#cb8-10"></a>reg3 <span class="ot">&lt;-</span> <span class="fu">feols</span>(<span class="fu">asin</span>(<span class="fu">sqrt</span>(poor)) <span class="sc">~</span> <span class="fu">asin</span>(<span class="fu">sqrt</span>(cropscoverfraction)) <span class="sc">+</span> <span class="fu">log</span>(mwpop), <span class="at">data =</span> pov, <span class="at">weights =</span> <span class="sc">~</span>total_weights, <span class="at">vcov =</span> <span class="st">"HC1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div id="tbl-povtrans" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-layout-align="center">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-povtrans-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Variable transformations
</figcaption>
<div aria-describedby="tbl-povtrans-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">

</div>
</div>
</figure>
</div>
</div>
<p>Transforming just the outcome improves the fit, at least as measured by r-squared, by around 7.2 percent. All of the transformations, however, increase the predictive power of the regression by 27.8 percent. In other words, the transformations of just these two variables, along with the outcome, can lead to a substantial improvement in the model.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
</section>
<section id="sec-lasso" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="sec-lasso"><span class="header-section-number">3.3</span> lasso and <code>glmnet</code></h2>
<p>In the above sections, we have shown how transforming our predictor and outcome variables can improve the fit of a model. However, we have not yet discussed how to choose which features to actually include in the model. Including all potential predictors has two primary problems:</p>
<ol type="1">
<li>First, we often have more predictors than observations. In this case, it is impossible to estimate the model.</li>
<li>Even if we have more observations than predictors, including all predictors can lead to overfitting. In essence, our model can end up predicting noise in the data, rather than true underlying relationships. This will lead to very poor performance, especially when predicting into out-of-sample data.</li>
</ol>
<p>There are many ways to select predictors, but the most commonly used method is “lasso”.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> Lasso is a regression method that “penalizes” coefficients. To put it simply, it will shrink coefficients to zero if they do not meaningfully improve the performance of the model. In practice, this approximately equalizes in-sample and out-of-sample r-squared.</p>
<p>In its simplest form, lasso is a linear regression model with an additional penalty term. We minimize the following objective function with respect to <span class="math inline">\(\beta\)</span>:</p>
<p><span class="math display">\[ (y-X\beta)^2 + \lambda \sum_{j=1}^p |\beta_j|, \]</span></p>
<p>where <span class="math inline">\(\lambda\)</span> is a tuning parameter that determines the size of the “penalty” and <span class="math inline">\((y-X\beta)^2\)</span> is the usual ordinary least squares minimiazation problem. Importantly, the penalty term can in principle take on any (non-negative) value. When <span class="math inline">\(\lambda=0\)</span>, lasso is just a linear regression. As <span class="math inline">\(\lambda\)</span> increases, fewer and fewer variables will be selected (i.e.&nbsp;will have non-zero coefficients). So what is the “correct” value for <span class="math inline">\(\lambda\)</span>? In practice, we often select <span class="math inline">\(\lambda\)</span> using cross validation.</p>
<div id="fig-cv" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-cv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Cross validation set up
</figcaption>
<div aria-describedby="fig-cv-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="assets/CVdiagram.png" class="img-fluid quarto-figure quarto-figure-center figure-img">
</div>
</figure>
</div>
<p>Cross validation is a process that is designed to mimic out-of-sample estimation. Consider the setup in <a href="#fig-cv" class="quarto-xref">Figure&nbsp;2</a>. We first take the sample data and randomize it into N <span class="math inline">\(folds\)</span>; the most common number of folds is 10, but the diagram shows five for simplicity. Since we are trying to mimic out-of-sample performance, we estimate a model on <span class="math inline">\(N-1\)</span> folds and then predict on the remaining fold. We then calculate the mean squared error (MSE) of the prediction. We repeat this process N times, each time leaving out a different fold. We can then find the mean MSE across all of the folds. We can repeat this process many times, for different values of <span class="math inline">\(\lambda\)</span>. The final (“optimal”) value of <span class="math inline">\(\lambda\)</span> is the one that minimizes the mean MSE across folds.</p>
<p>Thankfully, we do not need to do all of this by hand. Instead, we can use the <code>cv.glmnet()</code> function from the <code>glmnet</code> package. This function will automatically assign observations to folds and calculate MSE for different values of <span class="math inline">\(\lambda\)</span>. To do this, <code>glmnet</code> needs to be installed, which can be done using the <code>install.packages("glmnet")</code> function, and then loading the library with <code>library(glmnet)</code>.</p>
<p>The following code illustrates this process using already cleaned data. The cleaned features are in the <code>geovars.csv</code> data and the outcome is in the <code>ihs5ea.csv</code> data. Both datasets are again from Northern Malawi and are already collapsed to the admin4 (EA) level. First, load both datasets:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># load poverty</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>pov <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/ihs5ea.csv"</span>)</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co"># load features</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>features <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/geovarseas.csv"</span>)</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co"># add features to pov</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>pov <span class="ot">&lt;-</span> pov <span class="sc">|&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>  <span class="fu">left_join</span>(features, <span class="at">by =</span> <span class="st">"EA_CODE"</span>)</span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="fu">head</span>(pov)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 530
   EA_CODE   poor total_weights total_obs  fold TA_CODE mwpop average_masked
     &lt;dbl&gt;  &lt;dbl&gt;         &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;          &lt;dbl&gt;
1 10101006 0.230          5690.        16     4   10101 1123.          0.519
2 10101011 0.444          7614.        16     2   10101 1224.          0    
3 10101027 0.0947         9441.        16     5   10101 1292.          4.27 
4 10101033 0.376          7486.        16     4   10101  672.          0    
5 10101039 0.600          9147.        16     1   10101 1056.          0    
6 10101054 0.497          5351.        16     5   10101  864.          0    
# ℹ 522 more variables: barecoverfraction &lt;dbl&gt;, urbancoverfraction &lt;dbl&gt;,
#   cropscoverfraction &lt;dbl&gt;, grasscoverfraction &lt;dbl&gt;,
#   mosscoverfraction &lt;dbl&gt;, waterpermanentcoverfraction &lt;dbl&gt;,
#   waterseasonalcoverfraction &lt;dbl&gt;, shrubcoverfraction &lt;dbl&gt;,
#   snowcoverfraction &lt;dbl&gt;, treecoverfraction &lt;dbl&gt;, ndvi1 &lt;dbl&gt;, ndvi2 &lt;dbl&gt;,
#   ndvi3 &lt;dbl&gt;, ndvi4 &lt;dbl&gt;, ndvi5 &lt;dbl&gt;, ndvi6 &lt;dbl&gt;, ndvi7 &lt;dbl&gt;,
#   ndvi8 &lt;dbl&gt;, ndvi9 &lt;dbl&gt;, ndvi10 &lt;dbl&gt;, ndvi11 &lt;dbl&gt;, ndvi12 &lt;dbl&gt;, …</code></pre>
</div>
</div>
<p>We need to ensure we know which column includes the outcome of interest (in this case, <code>poor</code>) and which columns include all of the predictors. The data <code>geovarseas.csv</code> data has been cleaned such that there are only two non-predictors: the admin4 identifier (<code>EA_CODE</code>) and the admin3 identifier (<code>TA_CODE</code>). This means that all columns from <code>mwpop</code> to <code>ncol(pov)</code> are the predictors. We should be very specific about what <code>Y</code> and <code>X</code> are in this case, before using <code>cv.glmnet</code>.<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> In addition, recall that we discussed using a transformation of the outcome variable, specifically. Let’s also do that here:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="fu">asin</span>(<span class="fu">sqrt</span>(pov<span class="sc">$</span>poor)))</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co"># column 6 is the location of mwpop</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>X <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(pov[,<span class="dv">7</span><span class="sc">:</span><span class="fu">ncol</span>(pov)])</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="co"># here is the cross validation to select lambda</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="fu">set.seed</span>(<span class="dv">234056</span>) <span class="co"># set seed for consistent results!</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co"># five folds to keep with the simple example</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>cvresults <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(<span class="at">x =</span> X, <span class="at">y =</span> Y, <span class="at">nfolds =</span> <span class="dv">5</span>)</span>
<span id="cb11-8"><a href="#cb11-8"></a>cvresults</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:  cv.glmnet(x = X, y = Y, nfolds = 5) 

Measure: Mean-Squared Error 

     Lambda Index Measure       SE Nonzero
min 0.01986    35 0.04466 0.002446      10
1se 0.04180    19 0.04697 0.002626       4</code></pre>
</div>
</div>
<p>The <code>cvresults</code> object contains information about two different options for <span class="math inline">\(\lambda\)</span>: the value of <span class="math inline">\(\lambda\)</span> that minimizes MSE (<code>lambda.min</code>) and the value of <span class="math inline">\(\lambda\)</span> that is a bit larger (<code>lambda.1se</code>), meaning it is more conservative and will usually lead to fewer non-zero coefficients. In this example, the number of non-zero coefficients is either 10 or 4, depending on which <span class="math inline">\(\lambda\)</span> we choose.<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a> We can use the <code>plot()</code> function to see the results, with the results in <a href="#fig-cvresults" class="quarto-xref">Figure&nbsp;3</a> (the dotted lines represent the two “optimal” values of <span class="math inline">\(\lambda\)</span>).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">plot</span>(cvresults)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-cvresults" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-cvresults-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: CV results
</figcaption>
<div aria-describedby="fig-cvresults-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="6.features_files/figure-html/fig-cvresults-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<p>The next step is the most important: extracting the variables that have non-zero coefficients. While seeing the coefficients is straightforward, extracting the names of the variables is unfortunately more difficult than it probably should be.</p>
<p>To simply view the coefficients, we can use the <code>coef()</code> function, as shown below. Note that the code uses <code>head()</code> to keep the size of the R output to a managable size for this guide:<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">head</span>(<span class="fu">coef</span>(cvresults))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>6 x 1 sparse Matrix of class "dgCMatrix"
                              s1
(Intercept)         5.752724e-01
mwpop               .           
average_masked     -1.427754e-02
barecoverfraction   3.923403e-05
urbancoverfraction  .           
cropscoverfraction  .           </code></pre>
</div>
</div>
<p>The coefficients showing a <code>.</code> have zero value. We can use this fact to extract the names of the variables with non-zero coefficients. We can see this if we turn the <code>coef()</code> result into a matrix:<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">head</span>(<span class="fu">as.matrix</span>(<span class="fu">coef</span>(cvresults)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                              s1
(Intercept)         5.752724e-01
mwpop               0.000000e+00
average_masked     -1.427754e-02
barecoverfraction   3.923403e-05
urbancoverfraction  0.000000e+00
cropscoverfraction  0.000000e+00</code></pre>
</div>
</div>
<p>After turning the results into a matrix, we can see that the <code>.</code> coefficients become zeros. With this in mind, we can finally extract the names of the non-zero coefficients, as follows:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="co"># we can specify the lambda we want to use; "lambda.min" or "lambda.1se"</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>nonzero <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">coef</span>(cvresults, <span class="st">"lambda.min"</span>))</span>
<span id="cb18-3"><a href="#cb18-3"></a>nonzero <span class="ot">&lt;-</span> <span class="fu">rownames</span>(nonzero)[nonzero[,<span class="dv">1</span>]<span class="sc">!=</span><span class="dv">0</span>]</span>
<span id="cb18-4"><a href="#cb18-4"></a>nonzero</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "(Intercept)"        "average_masked"     "barecoverfraction" 
 [4] "urbancoverfraction" "mosaik1"            "mosaik39"          
 [7] "mosaik156"          "mosaik268"          "mosaik396"         
[10] "mosaik459"          "mosaik464"         </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># now remove the intercept (since this is automatically added)</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>nonzero <span class="ot">&lt;-</span> nonzero[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb20-3"><a href="#cb20-3"></a>nonzero</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "average_masked"     "barecoverfraction"  "urbancoverfraction"
 [4] "mosaik1"            "mosaik39"           "mosaik156"         
 [7] "mosaik268"          "mosaik396"          "mosaik459"         
[10] "mosaik464"         </code></pre>
</div>
</div>
<p>In this example, we have three non-zero coefficients, but we want to remove the intercept, which is always the first coefficient. We remove the intercept because it will automatically be added by the SAE function that we use later. This is done with the <code>nonzero &lt;- nonzero[-1]</code> line of code above.</p>
<p>The final step is to turn this into a <em>formula</em>, of the form <span class="math inline">\(outcome ~ x_1 + \cdots + x_n\)</span>, where <span class="math inline">\(x_1, \ldots, x_n\)</span> are the non-zero coefficients. We can do this with the <code>paste()</code> function and the <code>collapse</code> option, as follows:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>ebpformula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"poor ~ "</span>, <span class="fu">paste</span>(nonzero, <span class="at">collapse =</span> <span class="st">" + "</span>)))</span>
<span id="cb22-2"><a href="#cb22-2"></a>ebpformula</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>poor ~ average_masked + barecoverfraction + urbancoverfraction + 
    mosaik1 + mosaik39 + mosaik156 + mosaik268 + mosaik396 + 
    mosaik459 + mosaik464</code></pre>
</div>
</div>
<p>The <code>collapse = " + "</code> option tells <code>paste()</code> to separate the variables with a <code>+</code> sign. Finally, we have to explicitly tell <code>R</code> that this is a formula, which we do using <code>as.formula()</code>. This is the formula we will use below in section <strong>?@sec-estimating</strong>.</p>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>This is the for loop at the end of the <code>geospatialpull.ipynb</code> notebook.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The arcsin square root transformation is defined as <span class="math inline">\(y^*=\sin^{-1}(\sqrt{y})\)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>You can also use the <code>lm()</code> function from base <code>R</code>. However, we prefer the <code>feols()</code> function because it makes some things much easier, like adding weights.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>We note that we only show these results for illustrative purposes. In practice, we do not use r-squared as a measure of model fit, especially when only looking within the sample.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Lasso stands for “least absolute shrinkage and selection operator,” but it is often simply refered to by its acronym.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>A small note: the outcome needs to be a vector and the predictors need to be in the form of a matrix. Both of these requirements are specified in the code.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Note that we need to set a seed if we want consistent results when re-running the cross validation. This is because cross validation relies on some degree of randomness (in the allocation across folds).<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>The two non-negative variables visible in the output are nightlights (<code>average_masked</code>) and the proportion of the area that is bare ( <code>barecoverfraction</code>). Both coefficients are in the expected direction.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Again, <code>head()</code> is used to limit the output to the first few variables for practical purposes.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>